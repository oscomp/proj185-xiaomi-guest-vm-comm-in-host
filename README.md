# proj185-xiaomi-guest-vm-comm-in-host

## 宿主机内两个或者多个客户系统间的通讯

### 项目名称

宿主机内两个或者多个客户系统间的通讯

### 支持单位 （可选内容）

小米移动

### 项目描述

伴随着云技术的发展，Open vSwitch能够做到系统间数据包高质量转发，包括宿主机内多客户系统间的宿主机内转发，能满足大多数应用场景。但是这种技术基于网络协议栈，在内存共享、零拷贝、实时性等方面有着缺陷，这又是日益兴起的AIOT领域的强烈需求。

本项目目标是实现客户系统间实时的内存共享方式的通信机制，

• **主要手段**：

1 通过内存虚拟化的stage mmu实现不同客户系统共享内存来实现大数据的传递。

2 通过客户机、宿主机协同，软硬件一体设计提高实时性。

3 通过定制VCPU、中断、客户机内存（GPA）为上述实现提供基础。

• **客户机虚拟硬件**：

1. 扩展出一段GPA内存作为接受共享内存的区间。

2. 扩展出一个专用VCPU。客户机内核要保证使用共享内存的线程绑定在这个扩展的CPU上，且属于RT Sched Class。且Host保证这个VCPU对应线程属于RT Sched Class。

3. 扩展一个中断用来响应共享内存事件，该中断最好由扩展VCPU响应。

• **工作场景**

但客户机发起传输时，向KVM下发对端客户机及共享内存参数，KVM解析出需要共享的内存HPA，再将机器内存映射到对端客户机的stage2 MMU上。然后触发对端客户机扩展VCPU的特定中断，该中断handler唤醒客户机的处理线程。

本项目建议采用Linux KVM路线，主从系统皆为Linux，上层VMM可以自由选择，如QEMU、CrosVM均可。

参赛者也可采用type1路线，自主选择hypervisor，宿主系统仍需皆为Linux。

硬件架构建议采用arm64、x86-64，推荐的开发平台有rk3588、树莓派4。

### 所属赛道

2022全国大学生操作系统比赛的“OS功能挑战”赛道

项目导师

• 杨冬东：yangdongdong@xiaomi.com

• 赵小冰：zhaoxiaobing@xiaomi.com

### 难度

难度较高

### 预期目标

本项目有3个阶段

#### 第一阶段

基础层次，有完整的架构设计、基本的协议设计。

实现项目描述的功能。

#### 第二阶段

完善层次，有改进的架构设计，比如借助virtio、host机制改进VCPU中断机制；有基本协议设计、比如事务的定义支持同时或者依次分发给多个客户机；有安全性设计，如使用完毕及时隔断客户机对机器内存的映射。

基于完善的架构设计完成项目描述功能、且实现全部或者部分协议及安全性保护。

#### 第三阶段

挑战层次，完成以下真实场景：不停读取摄像头数据，然后依次交给客户机1、客户机2处理，最后显示出来。

摄像头操作、图像显示放在host、vmm、还是客户机中，不限制。

对于每一帧的处理算法不限，只需不少于5ms，若kvm方案实现基于前后端使用GPU，type1方案基于直通使用GPU，都是加分项。
